---
import '../../styles/global.css';
import { bunnyImage } from '../../lib/bunny-cdn';
import TitleSlide from '../../components/sections/Services/TitleSlide.astro';
import ThreeImageGrid from '../../components/sections/ThreeImageGrid/ThreeImageGrid.astro';
import ThreeImageGridFlipped from '../../components/sections/ThreeImageGrid/ThreeImageGridFlipped.astro';
import Navigation from '../../components/Navigation.astro';

const photoSlideBg = bunnyImage('/wp-content/uploads/2025/03/C4-Lindsay-St-Louis-Niko-Selects1-53.jpg', {
	pullZone: 'wordpress',
	width: 1920,
	quality: 85
});
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>times10 - Photo</title>
	</head>
	<body class="font-sans overflow-x-hidden bg-[#fdfffd]">
		<script>
			// Global error handler to prevent jQuery errors from breaking the page
			// jQuery may be injected by browser extensions or dev tools
			(function() {
				// Catch unhandled errors (including jQuery selector errors)
				window.addEventListener('error', function(event) {
					// Check if it's the jQuery selector error
					if (event.message && (
						event.message.includes("is not a valid selector") ||
						event.message.includes("*,:x") ||
						event.filename && event.filename.includes('jquery')
					)) {
						// Prevent the error from breaking the page
						event.preventDefault();
						console.warn('[Error Handler] Caught jQuery selector error (likely from browser extension):', event.message);
						return false;
					}
				}, true); // Use capture phase to catch errors early

				// Also catch unhandled promise rejections
				window.addEventListener('unhandledrejection', function(event) {
					if (event.reason && (
						event.reason.message && event.reason.message.includes("is not a valid selector") ||
						event.reason.message && event.reason.message.includes("*,:x")
					)) {
						event.preventDefault();
						console.warn('[Error Handler] Caught jQuery promise rejection:', event.reason);
					}
				});
			})();
		</script>
	<Navigation />
		<script>
			// Development: Save and restore scroll position
			// Remove this in production by deleting the script or setting ENABLE_SCROLL_RESTORE=false
			(function() {
				const STORAGE_KEY = 'dev-scroll-section';
				
				function initScrollRestore() {
					const sections = document.querySelectorAll('section[class*="snap-start"]');
					if (sections.length === 0) return;
					
					// Restore scroll position on load
					const savedIndex = sessionStorage.getItem(STORAGE_KEY);
					if (savedIndex !== null) {
						const index = parseInt(savedIndex, 10);
						if (index >= 0 && index < sections.length) {
							// Small delay to ensure layout is complete
							setTimeout(() => {
								sections[index].scrollIntoView({ behavior: 'instant' });
							}, 100);
						}
					}
					
					// Track current section using IntersectionObserver
					const observer = new IntersectionObserver((entries) => {
						entries.forEach((entry) => {
							if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
								const index = Array.from(sections).indexOf(entry.target);
								if (index !== -1) {
									sessionStorage.setItem(STORAGE_KEY, index.toString());
								}
							}
						});
					}, {
						threshold: 0.5,
						rootMargin: '-20% 0px -20% 0px'
					});
					
					// Observe all sections
					sections.forEach((section) => observer.observe(section));
				}
				
				// Wait for DOM to be ready
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initScrollRestore);
				} else {
					initScrollRestore();
				}
			})();
		</script>
		<TitleSlide 
			id="photo-title"
			backgroundImage={photoSlideBg}
			textParts={[
				{ text: 'photo', color: '#fff' }
			]}
			overlayOpacity={75}
		/>
		<ThreeImageGrid
			id="photo-grid-1" 
			images={[
				{
					src: '/wp-content/uploads/2025/03/C4-SS-Montez-and-Bianca-89.jpg',
					alt: 'Partnerships',
					label: 'partnerships',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				},
				{
					src: '/wp-content/uploads/2025/08/Flerish-ProductPhotos-07.28.25-80.jpg',
					alt: 'Product',
					label: 'product',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				},
				{
					src: '/wp-content/uploads/2025/09/7.2.21-C4-x-SI-x-JASMINE-10-1-1.jpg',
					alt: 'Lifestyle',
					label: 'lifestyle',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				}
			]}
		/>
		<ThreeImageGridFlipped 
			id="photo-grid-2"
			images={[
				{
					src: '/wp-content/uploads/2025/08/ClewDrais-53-1.jpg',
					alt: 'Event',
					label: 'event',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				},
				{
					src: '/wp-content/uploads/2025/02/060523-GoldGrove-62.jpeg',
					alt: 'Beauty',
					label: 'beauty',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				},
				{
					src: '/wp-content/uploads/2025/03/c4_07.09.22_austin_baura_9675.jpg',
					alt: 'Action + Sports',
					label: 'action + sports',
					pullZone: 'wordpress',
					width: 1200,
					quality: 85
				}
			]}
		/>
		<script>
			// Hash Scroll Manager - Handles both same-page and cross-page hash navigation
			// @ts-ignore - Inline script types
			(function() {
				function initHashScroll() {
					// Track if we're updating hash programmatically (to prevent scroll loops)
					let isUpdatingHash = false;
					
					// Helper function to generate section IDs
					function generateSectionId(section: Element, index: number): string {
						const heading = section.querySelector('h1, h2, h3, h4, h5, h6');
						if (heading) {
							const text = heading.textContent?.trim().toLowerCase() || '';
							if (text) {
								const slug = text
									.replace(/[^\w\s-]/g, '')
									.replace(/\s+/g, '-')
									.replace(/-+/g, '-')
									.replace(/^-|-$/g, '');
								if (slug.length > 0) {
									return slug;
								}
							}
						}
						return `section-${index + 1}`;
					}
					
					// Helper function to ensure all sections have IDs
					function ensureSectionIds(): void {
						const sections = document.querySelectorAll<HTMLElement>('section[class*="snap-start"]');
						sections.forEach((section, index) => {
							if (!section.id) {
								const sectionId = generateSectionId(section, index);
								section.id = sectionId;
							}
						});
					}
					
					// Helper function to scroll to hash target
					function scrollToHash(hash: string): boolean {
						// Ensure IDs are generated before looking for the target
						ensureSectionIds();
						
						const targetSection = document.getElementById(hash);
						if (targetSection) {
							// Use requestAnimationFrame to ensure layout is complete
							requestAnimationFrame(() => {
								requestAnimationFrame(() => {
									isUpdatingHash = true;
									targetSection.scrollIntoView({ behavior: 'instant' });
									// Reset flag after scroll completes
									setTimeout(() => {
										isUpdatingHash = false;
									}, 100);
								});
							});
							return true;
						}
						return false;
					}
					
					// Find all sections with snap-start class
					const sections = document.querySelectorAll<HTMLElement>('section[class*="snap-start"]');
					
					if (sections.length === 0) return;
					
					// Generate section IDs if they don't exist
					ensureSectionIds();
					
					// Handle initial hash on page load
					// This handles both same-page navigation and cross-page navigation
					const initialHash = window.location.hash.slice(1); // Remove #
					if (initialHash) {
						// Try immediately if page is already loaded
						if (document.readyState === 'complete') {
							// Page is fully loaded, try scrolling
							if (!scrollToHash(initialHash)) {
								// Element not found, retry with delay (might be dynamically added)
								setTimeout(() => {
									scrollToHash(initialHash);
								}, 300);
							}
						} else {
							// Wait for page to be fully loaded (including images, etc.)
							window.addEventListener('load', () => {
								if (!scrollToHash(initialHash)) {
									// Retry after a short delay if element still not found
									setTimeout(() => {
										scrollToHash(initialHash);
									}, 300);
								}
							}, { once: true });
						}
					}
					
					// Use Intersection Observer to detect visible sections
					const observer = new IntersectionObserver(
						(entries) => {
							// Don't update hash if we're programmatically scrolling
							if (isUpdatingHash) return;
							
							// Find the section with highest intersection ratio
							let maxRatio = 0;
							let activeSection: HTMLElement | null = null;
							
							for (const entry of entries) {
								if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
									maxRatio = entry.intersectionRatio;
									if (entry.target instanceof HTMLElement) {
										activeSection = entry.target;
									}
								}
							}
							
							// Update hash if we found an active section
							if (activeSection && activeSection.id) {
								const newHash = `#${activeSection.id}`;
								if (window.location.hash !== newHash) {
									// Use replaceState to avoid adding history entries
									window.history.replaceState(null, '', newHash);
								}
							}
						},
						{
							// Trigger when section is mostly visible (50%+)
							threshold: [0.5, 0.75, 1.0],
							// Add some margin to trigger slightly before section is fully visible
							rootMargin: '-10% 0px -10% 0px'
						}
					);
					
					// Observe all sections
					sections.forEach((section) => observer.observe(section));
					
					// Handle browser back/forward buttons
					window.addEventListener('popstate', () => {
						const hash = window.location.hash.slice(1);
						if (hash) {
							const targetSection = document.getElementById(hash);
							if (targetSection) {
								isUpdatingHash = true;
								targetSection.scrollIntoView({ behavior: 'smooth' });
								setTimeout(() => {
									isUpdatingHash = false;
								}, 500);
							}
						}
					});
				}
				
				// Initialize hash scroll functionality
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initHashScroll);
				} else {
					initHashScroll();
				}
			})();
		</script>
	</body>
</html>
