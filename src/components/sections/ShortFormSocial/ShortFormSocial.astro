---
import { LazyVideo } from '../../LazyVideo.tsx';

export interface Props {
	videos: Array<{
		src?: string;
		videoId?: string;
		poster?: string;
		pullZone?: string;
		priority?: boolean;
	}>;
	title?: string;
	id?: string;
}

const { videos, title = "short form social", id } = Astro.props;

// Group videos into rows: 1 per row on mobile, 2 per row on md, 4 per row on lg
// Create rows of 2 for medium screens, then combine pairs for large screens
function groupVideosIntoRows(videoList: typeof videos) {
	const rowsOf2: Array<Array<typeof videos[0]>> = [];
	
	// First, group by 2 for medium screens
	for (let i = 0; i < videoList.length; i += 2) {
		rowsOf2.push(videoList.slice(i, i + 2));
	}
	
	return rowsOf2;
}

const videoRows = groupVideosIntoRows(videos);
---

<section id={id} class="w-full h-dvh p-2 md:p-4 lg:p-8 snap-start snap-always flex flex-col overflow-hidden box-border">
	{title && (
		<div class="w-full text-center mb-4 shrink-0 sticky top-2 z-10 bg-white">
			<h2 class="text-[#ca2c1e] text-[2rem] md:text-[48px] lowercase font-bold leading-none tracking-wide">
				{title}
			</h2>
		</div>
	)}
	{/* Small screens: Show first 4 videos in 2x2 grid, no scroll */}
	<div class="flex-1 overflow-hidden md:overflow-y-auto md:overflow-x-hidden scrollbar-hide md:snap-y md:snap-mandatory">
		<div class="flex flex-col h-full pt-2 md:pt-0">
			{/* Small screens: 2x2 grid of first 4 videos */}
			<div class="flex items-center justify-center h-full md:hidden">
				<div class="grid grid-cols-2 grid-rows-2 sm:gap-4 gap-2 w-full h-full items-center justify-center border border-white box-border overflow-hidden">
					{videos.slice(0, 4).map((video) => (
						<div class="w-full h-full flex items-center justify-center overflow-hidden">
							<LazyVideo
								client:load
								src={video.src}
								videoId={video.videoId}
								poster={video.poster}
								pullZone={video.pullZone}
								priority={video.priority !== undefined ? video.priority : true}
								className="w-full h-full object-cover"
								autoPlay
								loop
								muted
								playsInline
							/>
						</div>
					))}
				</div>
			</div>
			
			{/* Medium/Large screens: Scrollable rows */}
			<div class="hidden md:flex flex-col h-full">
				{videoRows.map((row, index) => {
					const nextRow = index + 1 < videoRows.length ? videoRows[index + 1] : null;
					const shouldCombine = nextRow && row.length === 2 && nextRow.length === 2;
					const wasCombined = index > 0 && index % 2 === 1;
					
					// Skip if this row was already combined with previous
					if (wasCombined) {
						return null;
					}
					
					return (
						<>
							{/* Medium screens: Show individual rows of 2 videos */}
							<div class="w-full h-full shrink-0 snap-start snap-stop-always flex items-center justify-center lg:hidden">
								<div class="grid grid-cols-2 gap-4 w-full h-full items-center justify-center border border-white p-4 box-border overflow-hidden">
									{row.map((video) => (
										<div class="w-full h-full flex items-center justify-center p-0 overflow-hidden">
											<LazyVideo
												client:load
												src={video.src}
												videoId={video.videoId}
												poster={video.poster}
												pullZone={video.pullZone}
												priority={video.priority !== undefined ? video.priority : true}
												className="w-full h-full object-cover"
												autoPlay
												loop
												muted
												playsInline
											/>
										</div>
									))}
								</div>
							</div>
							{/* Large screens: Show combined rows of 4 videos */}
							{shouldCombine ? (
								<div class="hidden lg:flex w-full h-full shrink-0 snap-start snap-stop-always items-center justify-center">
									<div class="grid grid-cols-4 gap-4 w-full h-full items-center justify-center border border-white p-4 lg:pt-12 overflow-hidden">
										{[...row, ...nextRow].map((video) => (
											<div class="w-full h-full flex items-center justify-center p-0 overflow-hidden">
												<LazyVideo
													client:load
													src={video.src}
													videoId={video.videoId}
													poster={video.poster}
													pullZone={video.pullZone}
													priority={video.priority !== undefined ? video.priority : true}
													className="w-full h-full object-cover"
													autoPlay
													loop
													muted
													playsInline
												/>
											</div>
										))}
									</div>
								</div>
							) : (
								// Odd row at the end on large screens
								<div class="hidden lg:flex w-full h-full shrink-0 snap-start snap-stop-always items-center justify-center">
									<div class="grid grid-cols-4 gap-4 w-full h-full items-center justify-center border border-white p-4 lg:py-12 overflow-hidden">
										{row.map((video) => (
											<div class="w-full h-full flex items-center justify-center p-0 overflow-hidden">
												<LazyVideo
													client:load
													src={video.src}
													videoId={video.videoId}
													poster={video.poster}
													pullZone={video.pullZone}
													priority={video.priority !== undefined ? video.priority : true}
													className="w-full h-full object-cover"
													autoPlay
													loop
													muted
													playsInline
												/>
											</div>
										))}
									</div>
								</div>
							)}
						</>
					);
				})}
			</div>
		</div>
	</div>
</section>
