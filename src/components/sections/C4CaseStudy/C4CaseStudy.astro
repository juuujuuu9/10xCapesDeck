---
import { LazyImage } from '../../LazyImage.tsx';

export interface Props {
	image: {
		src: string;
		alt: string;
		pullZone?: string;
		priority?: boolean;
		width?: number;
		quality?: number;
	};
	challenge: string;
	whatWeDid: string;
	keyInitiatives: string[];
	id?: string;
}

const { image, challenge, whatWeDid, keyInitiatives, id } = Astro.props;

// Helper function to format text with bold prefix before colon
function formatWithBoldPrefix(text: string): string {
	const colonIndex = text.indexOf(':');
	if (colonIndex === -1) {
		return text;
	}
	const prefix = text.substring(0, colonIndex);
	const suffix = text.substring(colonIndex);
	return `<strong>${prefix}</strong>${suffix}`;
}
---

<section id={id} class="w-full h-dvh max-h-dvh snap-start snap-always flex flex-col overflow-hidden box-border bg-[#f4f4f0] lg:bg-transparent p-0 md:p-4 lg:p-8">
	{/* Desktop Layout - Unchanged */}
	<div class="hidden lg:grid w-full flex-1 min-h-0 grid-cols-2 gap-2 md:gap-4 lg:gap-8">
		{/* Left Column: Image */}
		<div class="relative overflow-hidden flex-1 min-h-0">
			<LazyImage
				client:visible
				src={image.src}
				alt={image.alt}
				pullZone={image.pullZone}
				priority={image.priority || false}
				width={image.width || 1200}
				quality={image.quality || 85}
				className="w-full h-full object-cover"
			/>
		</div>

		{/* Right Column: Text Content */}
		<div class="flex flex-1 min-h-0 flex-col justify-center overflow-y-auto">
			<div class="space-y-6 max-w-[650px] mx-auto">
				{/* Challenge Section */}
				<div>
					<h3 class="text-[#d63a2e] xl:text-[32px] lg:text-[24px] md:text-[20px] font-semibold leading-[32px] mb-4 text-left lowercase">
						challenge:
					</h3>
					<p class="text-[#010101] font-aktiv-grotesk xl:text-[20px] lg:text-[15px] md:text-[13px] font-semibold leading-[28px] text-left">
						{challenge}
					</p>
				</div>

				{/* What We Did Section */}
				<div>
					<h3 class="text-[#d63a2e] xl:text-[32px] lg:text-[24px] md:text-[20px] font-semibold leading-[32px] mb-4 text-left lowercase">
						what we did:
					</h3>
					{whatWeDid && (
						<p class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left inline">
							{whatWeDid}
						</p>
					)}
					{/* Key Initiatives List */}
					{keyInitiatives.length > 0 && (
						<>
							{whatWeDid && (
								<p class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left mt-4 font-semibold">
									key initiatives included:
								</p>
							)}
							<ol class={`space-y-2 list-decimal list-inside ${whatWeDid ? 'mt-4' : ''}`}>
								{keyInitiatives.map((initiative) => (
									<li class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left" set:html={formatWithBoldPrefix(initiative)}>
									</li>
								))}
							</ol>
						</>
					)}
				</div>
			</div>
		</div>
	</div>

	{/* Mobile Layout - New Design */}
	<div class="lg:hidden flex flex-col h-full w-full relative mobile-layout">
		{/* Hero Image Section with Concave Curve */}
		<div class="relative shrink-0 hero-section">
			<div class="hero-image-container">
				<LazyImage
					client:visible
					src={image.src}
					alt={image.alt}
					pullZone={image.pullZone}
					priority={image.priority || false}
					width={image.width || 1200}
					quality={image.quality || 85}
					className="w-full h-full object-cover"
				/>
			</div>
		</div>

		{/* White Content Card */}
		<div class="content-card flex flex-col overflow-hidden">
			{/* Tab Navigation */}
			{whatWeDid && keyInitiatives.length > 0 && (
				<div class="flex gap-3 px-4 pt-6 pb-4 shrink-0">
					<button
						class="tab-button flex-1 active"
						data-tab="overview"
						type="button"
						aria-label="Show overview content"
					>
						overview
					</button>
					<button
						class="tab-button flex-1"
						data-tab="initiatives"
						type="button"
						aria-label="Show key initiatives"
					>
						key initiatives
					</button>
				</div>
			)}
			{!whatWeDid && keyInitiatives.length > 0 && (
				<div class="px-4 pt-6 pb-4 shrink-0">
					<button
						class="tab-button w-full active"
						data-tab="overview"
						type="button"
						aria-label="Show the challenge"
					>
						the challenge
					</button>
				</div>
			)}
			{(!whatWeDid && keyInitiatives.length === 0) && (
				<div class="px-4 pt-6 pb-4 shrink-0">
					{/* No tabs needed when content is all in one place */}
				</div>
			)}

			{/* Tab Content */}
			<div class="tab-content-container flex-1 min-h-0 overflow-y-auto px-4 pb-6">
				{/* Overview Tab Content */}
				<div id="overview-content" class="tab-content active">
					<div class="space-y-6">
						{/* Challenge Section */}
						<div>
							<h3 class="text-[#d63a2e] text-[20px] font-semibold leading-[28px] mb-3 text-left lowercase">
								challenge:
							</h3>
							<p class="text-[#010101] text-[16px] leading-[24px] text-left">
								{challenge}
							</p>
						</div>

						{/* What We Did Section */}
						<div>
							<h3 class="text-[#d63a2e] text-[20px] font-semibold leading-[28px] mb-3 text-left lowercase">
								what we did:
							</h3>
							{whatWeDid && (
								<p class="text-[#010101] text-[16px] leading-[24px] text-left">
									{whatWeDid}
								</p>
							)}
							{keyInitiatives.length > 0 && (
								<ol class="space-y-3 list-decimal list-inside mt-3">
									{keyInitiatives.map((initiative) => (
										<li class="text-[#010101] text-[16px] leading-[24px] text-left" set:html={formatWithBoldPrefix(initiative)}>
										</li>
									))}
								</ol>
							)}
						</div>
					</div>
				</div>

				{/* Key Initiatives Tab Content - Only show if we have both whatWeDid and keyInitiatives */}
				{whatWeDid && keyInitiatives.length > 0 && (
					<div id="initiatives-content" class="tab-content">
						<div class="space-y-4">
							<ol class="space-y-3 list-decimal list-inside">
								{keyInitiatives.map((initiative) => (
									<li class="text-[#010101] text-[16px] leading-[24px] text-left" set:html={formatWithBoldPrefix(initiative)}>
									</li>
								))}
							</ol>
						</div>
					</div>
				)}
			</div>
		</div>
	</div>
</section>

<script>
	// Tab switching and card expansion functionality for mobile
	document.addEventListener('DOMContentLoaded', () => {
		// Only run on mobile
		if (window.innerWidth >= 1024) return;

		// Find all case study sections (scope to current component instance)
		const sections = document.querySelectorAll('section');
		sections.forEach((section) => {
			const mobileLayout = section.querySelector('.mobile-layout');
			if (!mobileLayout) return; // Skip if not this component

			const tabButtons = section.querySelectorAll('.tab-button');
			const tabContents = section.querySelectorAll('.tab-content');
			const contentContainer = section.querySelector('.tab-content-container');
			const contentCard = section.querySelector('.content-card');
			const tabNav = section.querySelector('.content-card > div:first-child');

			if (!contentCard || !contentContainer) return;

			// Function to expand the card
			const expandCard = () => {
				if (mobileLayout) {
					mobileLayout.classList.add('expanded');
				}
				if (contentCard) {
					contentCard.classList.add('expanded');
				}
				if (contentContainer) {
					contentContainer.classList.add('has-content');
				}
			};

			// Function to collapse the card
			const collapseCard = () => {
				if (mobileLayout) {
					mobileLayout.classList.remove('expanded');
				}
				if (contentCard) {
					contentCard.classList.remove('expanded');
				}
				if (contentContainer) {
					contentContainer.classList.remove('has-content');
				}
			};

			// Check if card is expanded
			const isExpanded = () => {
				return contentCard.classList.contains('expanded');
			};

			// Handle tab button clicks (if tabs exist)
			if (tabButtons.length > 0) {
				tabButtons.forEach((button) => {
					button.addEventListener('click', (e) => {
						e.stopPropagation();
						const targetTab = button.getAttribute('data-tab');
						if (!targetTab) return;

						// Expand card if not already expanded
						if (!isExpanded()) {
							expandCard();
						}

						// Only update button states and content visibility if there are multiple tabs
						if (tabContents.length > 0) {
							// Update button states
							tabButtons.forEach((btn) => btn.classList.remove('active'));
							button.classList.add('active');

							// Update content visibility
							tabContents.forEach((content) => {
								content.classList.remove('active');
								if (content.id === `${targetTab}-content`) {
									content.classList.add('active');
								}
							});
						}
					});
				});
			}

			// Handle clicks on the tab navigation area to expand/collapse
			if (tabNav) {
				tabNav.addEventListener('click', (e) => {
					// Don't toggle if clicking on a tab button (handled above)
					if (e.target.classList.contains('tab-button')) {
						return;
					}
					
					// Expand on first click
					if (!isExpanded()) {
						expandCard();
					}
				});
			}

			// If no tabs and no whatWeDid, make the card header area clickable to expand
			if (!tabButtons.length && !whatWeDid) {
				const cardHeader = section.querySelector('.content-card > div:first-child');
				if (cardHeader) {
					cardHeader.style.cursor = 'pointer';
					cardHeader.addEventListener('click', () => {
						if (!isExpanded()) {
							expandCard();
						}
					});
				}
			}

			// Add click handler to collapse when clicking outside content (on card background)
			contentCard.addEventListener('click', (e) => {
				// If clicking on the card itself (not children) and expanded, collapse
				if (e.target === contentCard && isExpanded()) {
					collapseCard();
				}
			});
		});
	});
</script>

<style>
	/* RULE-004: Font handling - aktiv-grotesk font family */
	.font-aktiv-grotesk {
		font-family: 'AktivGrotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
	}

	/* Mobile Hero Image with Concave Curve */
	@media (max-width: 1023px) {
		.hero-section {
			flex: 1;
			min-height: 0;
		}

		.hero-image-container {
			width: 100%;
			height: 100%;
			position: relative;
			overflow: hidden;
		}

		/* White Content Card with Prominent Rounded Top Corners */
		.content-card {
			background: white;
			border-radius: 48px 48px 0 0;
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			z-index: 1;
			padding-top: 0;
			box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
			height: auto;
			max-height: fit-content;
			transition: top 0.3s ease-out;
			cursor: pointer;
			/* Initially positioned at bottom, showing only buttons/tabs */
		}

		.content-card.expanded {
			top: calc(0.75rem + 0.5rem + 24px + 0.5rem + 1rem);
			/* top-3 (0.75rem) + p-2 top (0.5rem) + button height (24px) + p-2 bottom (0.5rem) + 1rem gap */
			bottom: 0;
			min-height: 0;
			max-height: none;
			overflow-y: auto;
			cursor: default;
		}

		/* Tab Buttons */
		.tab-button {
			padding: 10px 20px;
			border-radius: 9999px;
			font-size: 16px;
			font-weight: 500;
			background: white;
			color: #010101;
			border: 1px solid #010101;
			cursor: pointer;
			transition: all 0.2s;
			font-family: 'AktivGrotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
		}

		.tab-button.w-full {
			width: 100%;
		}

		.tab-button:hover {
			opacity: 0.9;
		}

		.tab-button:focus-visible {
			outline: 2px solid #d63a2e;
			outline-offset: 2px;
		}

		.tab-button.active {
			background: #d63a2e;
			color: white;
			border: 1px solid #d63a2e;
		}

		/* Tab Content Container - Hidden Initially */
		.tab-content-container {
			display: none;
		}

		.tab-content-container.has-content,
		.content-card.expanded .tab-content-container {
			display: flex;
		}

		/* Tab Content */
		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
		}
	}

	/* Key Initiatives List Numbers - Red Color */
	section ol.list-decimal li::marker {
		color: #d63a2e;
		font-weight: 600;
	}

	/* All text in section should be lowercase */
	section p,
	section li {
		text-transform: lowercase;
	}
</style>