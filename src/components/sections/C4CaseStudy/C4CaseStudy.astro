---
import { LazyImage } from '../../LazyImage.tsx';

export interface Props {
	image: {
		src: string;
		alt: string;
		pullZone?: string;
		priority?: boolean;
		width?: number;
		quality?: number;
	};
	challenge: string;
	whatWeDid: string;
	keyInitiatives: string[];
}

const { image, challenge, whatWeDid, keyInitiatives } = Astro.props;

// Helper function to format text with bold prefix before colon
function formatWithBoldPrefix(text: string): string {
	const colonIndex = text.indexOf(':');
	if (colonIndex === -1) {
		return text;
	}
	const prefix = text.substring(0, colonIndex);
	const suffix = text.substring(colonIndex);
	return `<strong>${prefix}</strong>${suffix}`;
}
---

<section class="w-full h-dvh max-h-dvh p-2 md:p-4 lg:p-8 snap-start snap-always flex flex-col overflow-hidden box-border">
	<div class="w-full flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-2 gap-2 md:gap-4 lg:gap-8">
		{/* Left Column: Image */}
		<div class="relative overflow-hidden flex-1 min-h-0">
			<LazyImage
				client:visible
				src={image.src}
				alt={image.alt}
				pullZone={image.pullZone}
				priority={image.priority || false}
				width={image.width || 1200}
				quality={image.quality || 85}
				className="w-full h-full object-cover"
			/>
			{/* MobileChallenge Section */}
			<div class="absolute bottom-0 left-0 p-4 lg:p-8 lg:hidden block max-w-[500px]">
				<h3 class="text-[#d63a2e] text-[28px] font-semibold leading-[32px] mb-2 text-left lowercase">
					challenge:
				</h3>
				<p class="text-white font-aktiv-grotesk md:text-[18px] font-semibold leading-[28px] text-left">
					{challenge}
				</p>
			</div>
		</div>

		{/* Right Column: Text Content */}
		<div class="hidden lg:flex flex-1 min-h-0 flex-col justify-center overflow-y-auto">
			<div class="space-y-6 max-w-[650px] mx-auto">
				{/* Challenge Section */}
				<div>
					<h3 class="text-[#d63a2e] xl:text-[32px] lg:text-[24px] md:text-[20px] font-semibold leading-[32px] mb-4 text-left lowercase">
						challenge:
					</h3>
					<p class="text-[#010101] font-aktiv-grotesk xl:text-[20px] lg:text-[15px] md:text-[13px] font-semibold leading-[28px] text-left">
						{challenge}
					</p>
				</div>

				{/* What We Did Section */}
				<div>
					<h3 class="text-[#d63a2e] xl:text-[32px] lg:text-[24px] md:text-[20px] font-semibold leading-[32px] mb-4 text-left lowercase">
						what we did:
					</h3>
				<p class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left inline">
					{whatWeDid}
				</p>
				{/* Key Initiatives List */}
				<p class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left mt-4 font-semibold">
					Key initiatives included:
				</p>
				<ol class="mt-4 space-y-2 list-decimal list-inside">
						{keyInitiatives.map((initiative) => (
							<li class="text-[#010101] xl:text-[20px] lg:text-[15px] md:text-[13px] leading-[28px] text-left" set:html={formatWithBoldPrefix(initiative)}>
							</li>
						))}
					</ol>
				</div>
			</div>
		</div>
	</div>
</section>

<!-- Mobile What We Did Section -->
<section 
	id="c4-mobile-text-section"
	class="w-full h-dvh max-h-dvh p-4 md:p-4 lg:p-8 lg:hidden snap-start snap-always flex flex-col overflow-hidden box-border"
>
	<div id="c4-mobile-scroll-container" class="flex-1 min-h-0 flex flex-col overflow-y-auto">
		<div id="c4-mobile-text-content" class="space-y-6">
			<h3 class="text-[#d63a2e] text-[28px] font-semibold leading-[32px] mb-4 text-left lowercase">
				what we did:
			</h3>
			<p class="text-[#010101] text-[18px] leading-[28px] text-left">
				{whatWeDid}
			</p>
			<p class="text-[#010101] text-[18px] leading-[28px] text-left mt-4 font-semibold">
				Key initiatives included:
			</p>
			<ol class="mt-4 space-y-2 list-decimal list-inside">
				{keyInitiatives.map((initiative) => (
					<li class="text-[#010101] text-[18px] leading-[28px] text-left" set:html={formatWithBoldPrefix(initiative)}>
					</li>
				))}
			</ol>
		</div>
	</div>
</section>

<script>
	// Mobile scroll behavior: When section enters viewport, position text at top
	// User scrolls through text, then continues to next section
	(function() {
		// Only run on mobile (lg:hidden section)
		if (window.innerWidth >= 1024) return;

		const section = document.getElementById('c4-mobile-text-section');
		const scrollContainer = document.getElementById('c4-mobile-scroll-container');
		if (!section || !scrollContainer) return;

		let hasPositioned = false;
		let isPositioning = false;

		// Intersection Observer to detect when section enters viewport
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting && !hasPositioned && !isPositioning) {
						// Section just entered viewport - position text at top
						isPositioning = true;
						hasPositioned = true;
						
						// Use requestAnimationFrame to ensure layout is complete
						requestAnimationFrame(() => {
							// Scroll the inner container so text content starts at top
							scrollContainer.scrollTop = 0;
							isPositioning = false;
						});
					} else if (!entry.isIntersecting) {
						// Section left viewport - reset flag for next time
						hasPositioned = false;
					}
				});
			},
			{
				threshold: 0.1,
				rootMargin: '0px'
			}
		);

		observer.observe(section);
	})();
</script>

<style>
	/* RULE-004: Font handling - aktiv-grotesk font family */
	.font-aktiv-grotesk {
		font-family: 'AktivGrotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
	}
</style>